为什么需要设计该方案？

原生websocket存在的问题

1.原生websocket的心跳基于TCP的keepalive机制。这个选项默认发送心跳检测数据包的时间间隔是7200秒（2小时），这时间间隔实在是太长了，不具有实用性。
虽然可以通过设置 keepalive 相关的三个选项TCP_KEEPIDLE、TCP_KEEPINTVL 和 TCP_KEEPCNT来改变这个时间间隔。但是这需要需要专业人员设置处理。并且这个设置不能够按应用隔离。在这个过程中也不方便注入业务层处理逻辑。
2.原生websocket的OnMessage方法是同步方法。直接在OnMessage中实现业务逻辑。如果业务很耗时会阻塞下一条消息的接收。这会造成客户端假死问题。
3.原生webSocket的send方无法实现可靠消息发送。用户调用send方法不能够确认消息发送成功。

该设计方案解决什么问题？

1.解决原生websocket心跳问题。通过自定义心跳机制可以在秒级感应网络环境变化。断线几秒内可以感应网络断开。同时可以注入相应的事件来处理业务逻辑。网络恢复后也能够在秒级实现重连。
2.使用线程池解决OnMessage同步问题。网络IO线程与业务线程隔离解决同步网络性能为题。假死问题。
3.在底层抽象一个消息协议层可以实现可靠消息传输（请求响应模型）、重试、消息持久化等特性。

具体实现

心跳方案

设计流程图



协议设计

serialNo

消息序列

cmd

|值|说明|
|:-----|:----| 
| async | 同步消息 |
| sync | 异步消息 |
| req-resp | 请求响应类型 |
| resp | 响应消息 |